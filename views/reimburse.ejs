<main>
    <div x-data="{
        transactionLog : [],
        toBeReimbursed : [],
        grid : null,
        grid2 : null,
        reimbursedTotal: 0,
        init(){
            fetch('/transactions')
                .then(data => data.json())
                .then(js => Alpine.raw(js.transactions))
                .then(transactions =>
                    {
                        this.grid = agGrid.createGrid(this.$refs.myGrid, {
                            rowData : transactions,
                            domLayout: 'autoHeight',
                            columnDefs : [
                                { field: 'transactionId', checkboxSelection: true},
                                { field: 'description'},
                                { field: 'amount' },
                                { field: 'recipient' },
                                { field: 'createdBy' },
                                { field: 'date'}
                            ],
                            defaultColDef: {
                                filter: 'agTextColumnFilter',
                                floatingFilter: true,
                            },
                            rowSelection: 'multiple',
                            onRowSelected: (event) => {
                                if (event.node.isSelected()) {
                                    this.toBeReimbursed.push(event.node.data);
                                    this.reimbursedTotal = this.reimbursedTotal + Number(event.node.data.amount);
                                    this.grid2.setRowData([...this.toBeReimbursed, {description: 'Total', amount : this.reimbursedTotal}])
                                    this.grid2.refreshCells()
                                    return
                                }
    
                                const index = this.toBeReimbursed.indexOf(event.node.data);
                                if (index < 0) {
                                    return
                                }
                                this.toBeReimbursed.splice(index, 1);
                                this.reimbursedTotal = this.reimbursedTotal - Number(event.node.data.amount);
                                let toBeReimbursed = [...this.toBeReimbursed]
                                if (this.reimbursedTotal > 0) {
                                    toBeReimbursed.push({description: 'Total', amount : this.reimbursedTotal})
                                }
                                this.grid2.setRowData(toBeReimbursed);
                                this.grid2.refreshCells()
                            }
                        })
                        this.grid2 = agGrid.createGrid(this.$refs.myGrid2, {
                            rowData : this.toBeReimbursed,
                            domLayout: 'autoHeight',
                            columnDefs : [
                                { field: 'description'},
                                { field: 'amount' },
                                {field: 'transactionId'},
                                { field: 'recipient' },
                                { field: 'createdBy' },
                                { field: 'date'}
                            ],
                            defaultColDef: {
                                filter: 'agTextColumnFilter',
                                floatingFilter: true,
                            },
                            getRowStyle: function(params) {
                                if (params.node.rowIndex === params.api.getDisplayedRowCount() - 1) {
                                    return { background: '#cce6ff', fontWeight: 'bold'}
                                }
                                return null;
                            },
                        })
                    }
                )
    
            htmx.on('#reimburse_button', 'click', (event) => {
                htmx.ajax('POST', '/reimburseBalance', {
                    target: 'main', 
                    swap:'outerHTML', 
                    values:{
                        toBeReimbursed: JSON.stringify(this.toBeReimbursed),
                        reimbursedTotal : this.reimbursedTotal,
                    } 
                })
            })

        },
        exportTableAsCsv() {
            this.grid2.exportDataAsCsv()
        }
    }">
    
    
        <div style="display: flex">
            <div style="flex: 1; margin-right: 20px">
                <h2>Current Transactions</h2>
                <div x-ref="myGrid" class="table ag-theme-quartz ag-center-cols-viewport" style="width: auto"></div>
            </div>
            <div style="flex: 1;">
                <div >
                    <h2>Reimbursements<h2>
                    <div x-ref="myGrid2" id="myGrid2" class="table ag-theme-quartz ag-center-cols-viewport"></div>
                    <div class="table_btns" x-show="toBeReimbursed.length > 0">
                        <button id="reimburse_button" class="solid" type="button">Reimburse</button>
                        <button type="button" class="reverse" @click="exportTableAsCsv()"> Export</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>