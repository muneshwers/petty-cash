<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
</head>
<link rel="stylesheet" href="../styles/style.css">
<body x-data="{ 
        tab : 'Create Transaction', 
        balance: 0,
        user: 'Stephon Fraser',
        grid: null,
    }"
    x-init=" 
    fetch('/balance').then(data => data.json()).then(json => balance = json.balance);
    "
    >
    <header>
        <h1><span class="company" >Muneshwers</span> Petty Cash</h1>
        <div class="navbar">
            <nav :class="(tab == 'Create Transaction' ) ? 'current' : '' "  x-on:click="tab = 'Create Transaction' " >Create Transaction</nav>
            <nav :class="(tab == 'Reimburse' ) ? 'current' : '' "  x-on:click="tab = 'Reimburse' " >Reimburse</nav>
        </div>
    </header>
    <main>
        <h2 x-text="tab"></h2>
        <div x-show="tab == 'Create Transaction' " >
            <div x-data="{
                inputs : {
                    amount :  {value: '', valid: false},
                    recipient : {value: '', valid: false},
                    description : {value: '', valid: false},
                    date : {value: (new Date()).toISOString().split('T')[0], valid: true},
                },
                validate() {
                    let keys = Object.keys(this.inputs)
                    for (let key of keys) {
                        if (!this.inputs[key].valid) {
                            return false
                        }
                    }
                    return true
                },
                formatDollar(number) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency : 'USD',
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0,
                    }).format(number)
                },
                sendData(inputs) {
                    fetch('/transactions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipient : inputs.recipient.value,
                            description : inputs.description.value,
                            amount : inputs.amount.value,
                            date : inputs.date.value,
                            createdBy : user,
                        }),
                    })
                    .then((res) => {
                        return res.json();
                    });
                }
            }
            " >
                <div class="amount-box">
                    <div class="amount"><div>Current Balance </div> <span style="color: green;"  x-text="formatDollar(balance)" ></span></div>
                    <div class="amount"><div>Amount </div> <span style="color: red;" x-text="formatDollar(Math.abs(inputs.amount.value) || 0)"></span></div>
                    <div class="amount"><div>Remainder </div> <span  x-text="formatDollar(balance - inputs.amount.value)" ></span></div>
                </div>
                <form>
                    <div class="transaction-form">
                        <div 
                            @validation="
                                inputs[$event.detail.field].value = $event.detail.input; 
                                inputs[$event.detail.field].valid = $event.detail.valid;"
                            class="item" 
                            x-data="{
                                input : '',
                                errorMessage : '',
                                initialized : false,
                                validate() {
                                    this.initialized = true
                                    if (!this.input) {
                                        this.errorMessage = 'recipient required'
                                        return false
                                    }
                                    this.errorMessage = ''
                                    return true
                                }
                        }">
                            <span class="errorMessage"  x-text="errorMessage"></span>
                            <input
                                x-on:input="let valid = validate(); $dispatch('validation', {valid, field : 'recipient', input})"
                                x-model="input"
                                x-bind:class="{'error' : errorMessage}"
                                placeholder="Recipient..."
                                type="text"
                                name="recipient"
                                id="recipient"
                            >
                        </div>
                        <div @validation="
                            inputs[$event.detail.field].value = $event.detail.input; 
                            inputs[$event.detail.field].valid = $event.detail.valid;
                            " 
                            class="item" x-data="{
                            input : '',
                            errorMessage : '',
                            initialized : false,
                            validate() {
                                this.initialized = true
                                if (!this.input) {
                                    this.errorMessage = 'description required'
                                    return false
                                }
                                this.errorMessage = ''
                                return true
                            }
                        }">
                            <span class="errorMessage" x-text="errorMessage"></span>
                            <input
                                x-on:input="let valid = validate(); $dispatch('validation', {valid, field : 'description', input})"
                                x-model="input"
                                x-bind:class="{'error' : errorMessage}"
                                placeholder="Description..."
                                type="text"
                                name="description"
                                id="description"
                            >
                        </div>
                        <div
                            @validation="
                            inputs[$event.detail.field].value = $event.detail.input; 
                            inputs[$event.detail.field].valid = $event.detail.valid;
                            "
                            class="item" 
                            x-data="{
                                input : '',
                                errorMessage : '',
                                initialized : false,
                                validate() {
                                    this.initialized = true
                                    if (!this.input) {
                                        this.errorMessage = 'amount required'
                                        return false
                                    }
                                    if (!Number(this.input)) {
                                        this.errorMessage = 'number required'
                                        return false
                                    }
                                    if (this.input < 0) {
                                        this.errorMessage = 'posivite values'
                                        return false
                                    }
                                    if (this.balance - this.input < 0) {
                                        this.errorMessage = 'Insufficient funds'
                                        return false
                                    }
                                    this.errorMessage = ''
                                    return true
                                }
                        }">
                            <span class="errorMessage" x-text="errorMessage"></span>
                            <input
                                x-on:input="let valid = validate(); $dispatch('validation', {valid, field : 'amount', input})"
                                x-model="input"
                                x-bind:class="{'error' : errorMessage}"
                                type="number"
                                placeholder="Amount..."
                                name="amount"
                                id="amount"
                            >
                        </div>
                        <div class="item" x-data="{
                            input : (new Date()).toISOString().split('T')[0],
                            errorMessage : '',
                            initialized : false,
                            validate() {
                                this.initialized = true
                                if (!this.input) {
                                    this.errorMessage = 'date required'
                                    return false
                                }
                                this.errorMessage = ''
                                return true
                            }
                        }">
                            <span class="errorMessage" x-text="errorMessage"></span>
                            <input
                                x-on:input="let valid = validate(); $dispatch('validation', {valid, field : 'date', input})"
                                x-model="input"
                                x-bind:class="{'error' : errorMessage}"
                                type="date"
                                name="date"
                                id="date"
                            >
                        </div>
                    </div>
                    <button class="submit-button" type="submit" :disabled="!validate()" x-on:click="sendData(inputs)" >Submit</button>
                </form>
            </div>
        </div>
        <div 
            x-show="tab == 'Reimburse'"
            x-data="{
                transactionLog : [],
                toBeReimbursed : [],
                grid : null,
                grid2 : null,
                init(){
                    fetch('/transactions')
                        .then(data => data.json())
                        .then(js => Alpine.raw(js.transactionLog))
                        .then(transactions => 
                            {   
                                this.grid = agGrid.createGrid(this.$refs.myGrid, {
                                rowData : transactions,
                                columnDefs : [
                                    { field: 'description', checkboxSelection: true},
                                    { field: 'amount' },
                                    { field: 'recipient' },
                                    { field: 'createdBy' },
                                    { field: 'date'}
                                ],
                                rowSelection: 'multiple',
                                onRowSelected: (event) => {
                                    if(event.node.isSelected()) {
                                        console.log(event.node.data, ' :Selected and added to ', this.toBeReimbursed);
                                        this.toBeReimbursed.push(event.node.data);
                                        this.grid2.setRowData(this.toBeReimbursed)
                                        this.grid2.refreshCells()
                                    } else {
                                        console.log(event.node.data, ' :Deselected and removed.');
                                        const index = this.toBeReimbursed.indexOf(event.node.data);

                                        if (index > -1) {
                                            this.toBeReimbursed.splice(index, 1);
                                        }
                                        console.log('Reimbused list now: ', this.toBeReimbursed);
                                    }
                                }
                            })
                            console.log(this.toBeReimbursed)
                            this.grid2 = agGrid.createGrid(this.$refs.myGrid2, {
                                rowData : this.toBeReimbursed,
                                columnDefs : [
                                    { field: 'description'},
                                    { field: 'amount' },
                                    { field: 'recipient' },
                                    { field: 'createdBy' },
                                    { field: 'date'}
                                ],
                            })
                        }
                        )
                    
                }
            }"
        >
            <div x-show="toBeReimbursed.length > 0">
                <div x-ref="myGrid2" class="ag-theme-quartz" style="height: 500px"></div>
            </div>
            <div x-ref="myGrid"  class="ag-theme-quartz" style="height: 500px"></div>
        </div>
    </main>
</body>
</html>